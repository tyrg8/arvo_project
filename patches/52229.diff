commit 2d153fba45325e4fe716ff92a44eb67fe0fcea72
Author: Ivan Nardi <12729895+IvanNardi@users.noreply.github.com>
Date:   Fri Oct 14 20:59:33 2022 +0200

    HTTP: fix stack-buffer-overflow (#1768)
    
    ```
    ==24879==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7fa085b31e60 at pc 0x55cc63f203e2 bp 0x7ffc9ec91b10 sp 0x7ffc9ec91298
    READ of size 17 at 0x7fa085b31e60 thread T0
        #0 0x55cc63f203e1 in printf_common(void*, char const*, __va_list_tag*) asan_interceptors.cpp.o
        #1 0x55cc63f20769 in vsnprintf (/home/ivan/svnrepos/nDPI/fuzz/fuzz_process_packet_with_main+0x50e769) (BuildId: cce2b6b1344bfd0bdc9626fef604c2b3caad485b)
        #2 0x55cc63f22210 in __interceptor_snprintf (/home/ivan/svnrepos/nDPI/fuzz/fuzz_process_packet_with_main+0x510210) (BuildId: cce2b6b1344bfd0bdc9626fef604c2b3caad485b)
        #3 0x55cc6420fc76 in ndpi_check_http_server /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:668:4
        #4 0x55cc6420344b in check_content_type_and_change_protocol /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:742:5
        #5 0x55cc642031ce in check_content_type_and_change_protocol /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:737:7
        #6 0x55cc641fac9f in ndpi_check_http_tcp /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:1352:4
        #7 0x55cc641f2fd5 in ndpi_search_http_tcp /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:1461:3
        #8 0x55cc64085275 in check_ndpi_detection_func /home/ivan/svnrepos/nDPI/src/lib/ndpi_main.c:5580:6
        #9 0x55cc64085c87 in check_ndpi_tcp_flow_func /home/ivan/svnrepos/nDPI/src/lib/ndpi_main.c:5628:12
        #10 0x55cc64085927 in ndpi_check_flow_func /home/ivan/svnrepos/nDPI/src/lib/ndpi_main.c:5647:12
        #11 0x55cc64095fcb in ndpi_detection_process_packet /home/ivan/svnrepos/nDPI/src/lib/ndpi_main.c:6458:15
        #12 0x55cc63fd08b4 in LLVMFuzzerTestOneInput /home/ivan/svnrepos/nDPI/fuzz/fuzz_process_packet.c:29:5
        #13 0x55cc63fd09f7 in main /home/ivan/svnrepos/nDPI/fuzz/fuzz_process_packet.c:101:17
        #14 0x7fa0880fb082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16
        #15 0x55cc63efb45d in _start (/home/ivan/svnrepos/nDPI/fuzz/fuzz_process_packet_with_main+0x4e945d) (BuildId: cce2b6b1344bfd0bdc9626fef604c2b3caad485b)
    
    Address 0x7fa085b31e60 is located in stack of thread T0 at offset 96 in frame
        #0 0x55cc6420f1bf in ndpi_check_http_server /home/ivan/svnrepos/nDPI/src/lib/protocols/http.c:644
    
      This frame has 5 object(s):
        [32, 36) 'a' (line 653)
        [48, 52) 'b' (line 653)
        [64, 68) 'c' (line 653)
        [80, 96) 'buf' (line 654)
        [112, 176) 'msg' (line 662) <== Memory access at offset 96 partially underflows this variable
    
    ```
    Found by oss-fuzzer
    See: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=52229

diff --git a/src/lib/protocols/http.c b/src/lib/protocols/http.c
index 3430af94..7e6ae2d2 100644
--- a/src/lib/protocols/http.c
+++ b/src/lib/protocols/http.c
@@ -644,40 +644,40 @@ static void ndpi_check_http_url(struct ndpi_detection_module_struct *ndpi_struct
 static void ndpi_check_http_server(struct ndpi_detection_module_struct *ndpi_struct,
 				   struct ndpi_flow_struct *flow,
 				   const char *server, u_int server_len) {
   if(server_len > 7) {
     u_int off;
   
     if(strncmp((const char *)server, "ntopng ", 7) == 0) {
       ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_NTOP, NDPI_PROTOCOL_HTTP, NDPI_CONFIDENCE_DPI);
       NDPI_CLR_BIT(flow->risk, NDPI_KNOWN_PROTOCOL_ON_NON_STANDARD_PORT);
     } else if((strncasecmp(server, "Apache/", off = 7) == 0) /* X.X.X */
 	      || (strncasecmp(server, "nginx/", off = 6) == 0) /* X.X.X */) {
       u_int i, j, a, b, c;
       char buf[16] = { '\0' };
 
-      for(i=off, j=0; (i<server_len) && (j<sizeof(buf))
+      for(i=off, j=0; (i<server_len) && (j<sizeof(buf)-1)
 	    && (isdigit(server[i]) || (server[i] == '.')); i++)
 	buf[j++] = server[i];      
 
       if(sscanf(buf, "%d.%d.%d", &a, &b, &c) == 3) {
 	u_int32_t version = (a * 1000000) + (b * 1000) + c;
 	char msg[64];
 	
 	if((off == 7) && (version < MIN_APACHE_VERSION)) {
 	  snprintf(msg, sizeof(msg), "Obsolete Apache server %s", buf);
 	  ndpi_set_risk(ndpi_struct, flow, NDPI_HTTP_OBSOLETE_SERVER, msg);
 	} else if((off == 6) && (version < MIN_NGINX_VERSION)) {
 	  snprintf(msg, sizeof(msg), "Obsolete nginx server %s", buf);
 	  ndpi_set_risk(ndpi_struct, flow, NDPI_HTTP_OBSOLETE_SERVER, msg);
 	}
       }
     }
   }
 }
 
 /* ************************************************************* */
 
 /**
    NOTE
    ndpi_parse_packet_line_info is in ndpi_main.c
 */
